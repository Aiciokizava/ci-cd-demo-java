name: CI/CD Pipeline for Java Project

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java-version: [11, 17]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        run: mvn clean compile

      - name: Run tests
        run: mvn test

      - name: Package application
        run: mvn package -DskipTests

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-app-${{ matrix.os }}-jdk${{ matrix.java-version }}
          path: target/*.jar

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Package final jar
        run: mvn package -DskipTests

      - name: Display JAR contents
        run: ls -la target/

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp target/*.jar deployment/
          echo "Deployment time: $(date)" > deployment/deployment-info.txt
          tar -czf deployment.tar.gz deployment/

      - name: SSH Deploy (Example)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          # Этот шаг активируется только если настроены секреты
          if [[ -n "$SSH_PRIVATE_KEY" && -n "$SSH_HOST" ]]; then
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          
            echo "Deploying to $SSH_HOST..."
            # Здесь будут команды для реального деплоя
            # scp deployment.tar.gz $SSH_USER@$SSH_HOST:/tmp/
            # ssh $SSH_USER@$SSH_HOST "tar -xzf /tmp/deployment.tar.gz -C /opt/app/"
            echo "Deployment commands would run here"
          else
            echo "SSH deployment skipped - secrets not configured"
          fi

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.tar.gz

  notify:
    needs: [build-and-test, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Build and test completed with status: ${{ needs.build-and-test.result }}"
          echo "Deploy completed with status: ${{ needs.deploy.result }}"
